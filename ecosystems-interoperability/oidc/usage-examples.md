# SSIKit usage examples for OIDC issuance and presentation exchange

The following subsections show several examples of interaction with OIDC compliant issuers and verifiers using the SSIKit command line interface.

## Credential issuance

For interacting with an OIDC credential issuer, we need to know the OIDC base URL of the issuer service. The SSIKit tries to resolve the OIDC discovery document relative to that base URL like this:

`<base URL>/.well-known/openid-configuration`

For this example, let's use our demo issuance service published on:

`https://issuer.walt.id/issuer-api/oidc/`

### Issuer info

First let's get some information about the credentials, the issuer provides, and possibly, which types of credentials we must present, in order to obtain the issued credentials.

```
ssikit oidc ci info -i "https://issuer.walt.id/issuer-api/oidc/"
```

_Output_

```
[...]
Issuer:
walt.id Issuer Portal
---
Issuable credentials:
[...]
- VerifiableId
Schema ID: https://api.preprod.ebsi.eu/trusted-schemas-registry/v1/schemas/0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba
- EuropeanBankIdentity
Schema ID: https://raw.githubusercontent.com/walt-id/waltid-ssikit-vclib/master/src/test/resources/schemas/EuropeanBankCredential.json
---
Required VP:
<None>

```

The issuer lists the supported credential types and their schema IDs, as well as required VPs, which are _None_ in our demo service.

### Initiate credential issuance session

To initiate a credential issuance session, we have to push an authorization request to the issuer service, containing information about which credential we want to get issued, and a possibly required verifiable presentation:

```
ssikit oidc ci auth -i "https://issuer.walt.id/issuer-api/oidc/" -n "FOO" -r "https://blank" -s "https://api.preprod.ebsi.eu/trusted-schemas-registry/v1/schemas/0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba"
```

{% hint style="info" %}
For more options of the _auth_ subcommand, type 

`ssikit oidc ci auth --help`
{% endhint %}

Let's break up the above command: 
* **-i [...]**: Set the issuer base URL
* **-n [...]**: A nonce we define, for the issuer to sign the id_token in a later step
* **-r [...]**: Set a dummy redirect address, as we just need to copy the final redirection URL from the browser lateron.
* **-s [...]**: Request issuance of a VerifiableID credential, by specifying its schema ID

_Output_

```
[...]
Point your browser to this address and authorize with the issuer:
https://issuer.walt.id/issuer-api/oidc/fulfillPAR?client_id=https://blank&request_uri=urn:ietf:params:oauth:request_uri:a58b8919-4922-4140-a46b-e89f7b36d87c

Then paste redirection url from browser to this command to retrieve the access token:
ssikit oidc ci token -i https://issuer.walt.id/issuer-api/oidc/ -r <url from browser>
```

Let's now follow the instructions the CLI printed, and open that link in the browser: `https://issuer.walt.id/issuer-api/oidc/fulfillPAR?[...]`, to proceed to the issuer portal and continue with the credential issuance session.

After completing the issuance session in the issuer web portal, we continue with the token request, as instructed by above command output.

### Token request

Once we completed the issuance session on the issuer web portal, we get redirected to the dummy address we specified, like we can see in this screenshot:

![Issuer redirect screenshot](./issuer-redirect-screenshot.png)

We copy that URL from the browser and fetch the _id_token_ and _access_token_ from the issuer like so:

```
ssikit oidc ci token -i https://issuer.walt.id/issuer-api/oidc/ -r "https://blank/?code=a58b8919-4922-4140-a46b-e89f7b36d87c&state=XqLV33eiLjSJSJf58KC9m2U9PYfT6jmmMcnRfJaz_ow"
```

{% hint style="info" %}
For more options of the _token_ subcommand, type 

`ssikit oidc ci token --help`
{% endhint %}

Breakdown of above command:
* **-i [...]**: Set the issuer base URL
* **-r [...]**: The redirection URL copied from the browser, including the _authorization code_ parameter, generated by the issuer portal.

_Output_

 ```
 [...]
 Access token response:
{
    "access_token":"a58b8919-4922-4140-a46b-e89f7b36d87c",
    "refresh_token":"4OKWdsX2hOMveLwEGSpjhQnZwc5sNC-Bit6VbticyKI",
    "c_nonce":"5685e1d3-7da7-453c-9776-555217564f21",
    "id_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhNThiODkxOS00OTIyLTQxNDAtYTQ2Yi1lODlmN2IzNmQ4N2MifQ.AreLW-7O_P7tWB3_mkb69Fhdv8G9kVrcxWEA0wtDpp0",
    "token_type":"Bearer",
    "expires_in":300
}

Now get the credential using:
ssikit oidc ci credential -i https://issuer.walt.id/issuer-api/oidc/ -m OIDC -t a58b8919-4922-4140-a46b-e89f7b36d87c -n 5685e1d3-7da7-453c-9776-555217564f21 -d <subject did> -s <credential schema id>
```

Let's break down the important bits of the token response:
* **access_token**: The token which we need to request the credentials
* **id_token**: ID token, which should have been signed by the issuer, respecting the _nonce_ challenge we defined previously in the _auth_ subcommand.
* **c_nonce**: The nonce challenge we need to use, to sign the DID ownership proof in the credential request.
* **expires_in**: expiration period (seconds), after which the token will become invalid.

Let's now proceed with the credential request, like instructed by the command output.

### Credential request

Once we retrieved the _access_token_, we can fetch the actual credential from the issuer. This command can be repeated for each credential schema type we requested in the _auth_ subcommand previously.

```
ssikit oidc ci credential -i https://issuer.walt.id/issuer-api/oidc/ -m OIDC -t a58b8919-4922-4140-a46b-e89f7b36d87c -n 5685e1d3-7da7-453c-9776-555217564f21 -d did:key:z6Mktxjvto1vueoMXiiAtLQiCrDPd2Xoi47isAnjK12nETRX -s "https://api.preprod.ebsi.eu/trusted-schemas-registry/v1/schemas/0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba" --save
```

{% hint style="info" %}
For more options of the _credential_ subcommand, type 

`ssikit oidc ci credential --help`
{% endhint %}

Breakdown of above command:
* **-i [...]**: Set the issuer base URL
* **-m OIDC**: Follow the OIDC standard (default)
* **-t [...]**: The access_token we received previously
* **-n [...]**: The nonce used for signing the DID ownership proof
* **-d [...]**: The DID for which the credential should be issued (we have to proof DID ownership!)
* **-s [...]**: The schema ID of the credential to retrieve
* **--save**: We instruct the CLI to save the received credential to the credential store

_Output_
```
[...]
VerifiableId(
    context=[
        https://www.w3.org/2018/credentials/v1
    ],
    id=urn:uuid:ad5a242e-4343-4c40-b58e-33ab60251b18,
    issuer=did:key:z6MkhHz9tcWcWmRXpKyoduLV6fYXhzFeRfmRmseoRggZeB6g,
    issued=2022-03-11T11:32:53.433306061Z,
[...]
    credentialSubject=VerifiableIdSubject(
        id=did:key:z6Mktxjvto1vueoMXiiAtLQiCrDPd2Xoi47isAnjK12nETRX,
[...]
    ),
[...]
    proof=Proof(
        type=Ed25519Signature2018,
        creator=did:key:z6MkhHz9tcWcWmRXpKyoduLV6fYXhzFeRfmRmseoRggZeB6g,
[...]
    )
)

Stored as urn:uuid:aa1a51cd-3ad2-49fe-ae3e-5ae50c4aed3b
```

As we can see, we received the VerifiableID credential for the DID subject we specified and the credential was stored.

## Credential presentation

The credential presentation flow is triggered from a Verifier portal, sending an OIDC/SIOP authorization request to the wallet, which acts as a Self-Issued OpenID Provider (SIOP).

To play through the verification flow, let's start at our demo verifier web portal at:

`https://verifier.walt.id`

### SIOP request

To obtain a valid SIOP request URL from the verifier, let's open the verifier portal in a web browser.

Hit the F12 button, to open the developer tools and navigate to the "Network" tab (make sure the request type filter shows _All_ requests), like shown in the following screenshot:

![Verifier portal and network tab](./verifier-portal-network-tab.png)

Now hit the "Connect to wallet using VerifiableID" button. The verifier portal redirects to the web wallet, and you find the relevant SIOP request, in the network tab with the request URI starting as `/api/wallet/siopv2/initPresentation`, like shown in this screenshot:

![Wallet SIOP redirection](./wallet-siop-redirect.png)

We want to copy the SIOP request URL, in this example it's:

```
https://wallet.walt.id/api/wallet/siopv2/initPresentation/?response_type=id_token&response_mode=form_post&client_id=https%3A%2F%2Fverifier.walt.id%2Fverifier-api%2Fverify%2F842b3286-d581-4d6b-ad1d-16a718c28015&redirect_uri=https%3A%2F%2Fverifier.walt.id%2Fverifier-api%2Fverify%2F842b3286-d581-4d6b-ad1d-16a718c28015&scope=openid&nonce=842b3286-d581-4d6b-ad1d-16a718c28015&claims=%7B%22vp_token%22+%3A+%7B%22presentation_definition%22+%3A+%7B%22id%22+%3A+%221%22%2C+%22input_descriptors%22+%3A+%5B%7B%22id%22+%3A+%221%22%2C+%22schema%22+%3A+%7B%22uri%22+%3A+%22https%3A%2F%2Fapi.preprod.ebsi.eu%2Ftrusted-schemas-registry%2Fv1%2Fschemas%2F0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba%22%7D%7D%5D%7D%7D%7D
```

#### Simulate a SIOP request

**_Alternatively_**, we can simulate a SIOP request, by using the SSIKit command line interface, to generate such a request URL:

```
ssikit oidc vp gen-url -v "http://blank" -p "/verify/" -n "FOO" -s "https://api.preprod.ebsi.eu/trusted-schemas-registry/v1/schemas/0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba" --state "BAR"
```

Breakdown of the command:
* **-v [...]**: Dummy verifier address
* **-p [...]**: Dummy verification redirect path, relative to verifier address
* **-n [...]**: Nonce to include in verifiable presentation in the SIOP response
* **-s [...]**: Schema ID of the requested credential
* **--state [...]**: Custom state identifier, that is looped through to the SIOP response

_Output_

```
[...]
openid://?response_type=id_token&response_mode=fragment&client_id=http%3A%2F%2Fblank%2Fverify%2F&redirect_uri=http%3A%2F%2Fblank%2Fverify%2F&scope=openid&nonce=FOO&claims=%7B%22vp_token%22+%3A+%7B%22presentation_definition%22+%3A+%7B%22id%22+%3A+null%2C+%22input_descriptors%22+%3A+%5B%7B%22id%22+%3A+null%2C+%22schema%22+%3A+%7B%22uri%22+%3A+%22https%3A%2F%2Fapi.preprod.ebsi.eu%2Ftrusted-schemas-registry%2Fv1%2Fschemas%2F0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba%22%7D%7D%5D%7D%7D%7D&state=BAR
```

The command prints the SIOP request URI containing the required credential types, as specified in the command parameters.

### Parse SIOP request

Continuing the real-case scenario we started on our demo verifier portal, we can copy the SIOP request URL from the browser network tab, like shown in the previous section, and inspect the SIOP request to see which credentials we have to present, using the _parse_ subcommand like this:

```
ssikit oidc vp parse -u "https://wallet.walt.id/api/wallet/siopv2/initPresentation/?response_type=id_token&response_mode=form_post&client_id=https%3A%2F%2Fverifier.walt.id%2Fverifier-api%2Fverify%2F842b3286-d581-4d6b-ad1d-16a718c28015&redirect_uri=https%3A%2F%2Fverifier.walt.id%2Fverifier-api%2Fverify%2F842b3286-d581-4d6b-ad1d-16a718c28015&scope=openid&nonce=842b3286-d581-4d6b-ad1d-16a718c28015&claims=%7B%22vp_token%22+%3A+%7B%22presentation_definition%22+%3A+%7B%22id%22+%3A+%221%22%2C+%22input_descriptors%22+%3A+%5B%7B%22id%22+%3A+%221%22%2C+%22schema%22+%3A+%7B%22uri%22+%3A+%22https%3A%2F%2Fapi.preprod.ebsi.eu%2Ftrusted-schemas-registry%2Fv1%2Fschemas%2F0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba%22%7D%7D%5D%7D%7D%7D"
```

_Output_

```
[...]
Requested credentials:
- VerifiableId
Schema ID: https://api.preprod.ebsi.eu/trusted-schemas-registry/v1/schemas/0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba

```

The command prints the requested credentials and their schema IDs. Now we can create and send the SIOP response to the verifier portal.

### SIOP response

Using the SIOP request URL we got in the previous sections, we can now generate and post the SIOP response, using the DID and credential issued in the [issuance credential request example](#credential-request), to the verifier portal like so:

```
ssikit oidc vp present -u "https://wallet.walt.id/api/wallet/siopv2/initPresentation/?response_type=id_token&response_mode=form_post&client_id=https%3A%2F%2Fverifier.walt.id%2Fverifier-api%2Fverify%2F842b3286-d581-4d6b-ad1d-16a718c28015&redirect_uri=https%3A%2F%2Fverifier.walt.id%2Fverifier-api%2Fverify%2F842b3286-d581-4d6b-ad1d-16a718c28015&scope=openid&nonce=842b3286-d581-4d6b-ad1d-16a718c28015&claims=%7B%22vp_token%22+%3A+%7B%22presentation_definition%22+%3A+%7B%22id%22+%3A+%221%22%2C+%22input_descriptors%22+%3A+%5B%7B%22id%22+%3A+%221%22%2C+%22schema%22+%3A+%7B%22uri%22+%3A+%22https%3A%2F%2Fapi.preprod.ebsi.eu%2Ftrusted-schemas-registry%2Fv1%2Fschemas%2F0xb77f8516a965631b4f197ad54c65a9e2f9936ebfb76bae4906d33744dbcc60ba%22%7D%7D%5D%7D%7D%7D" -d did:key:z6Mktxjvto1vueoMXiiAtLQiCrDPd2Xoi47isAnjK12nETRX -c urn:uuid:aa1a51cd-3ad2-49fe-ae3e-5ae50c4aed3b
```

Command breakdown:
* **-u [...]**: The SIOP request URL copied from the browser network tab
* **-d [...]**: The DID to use, for signing the verifiable presentation
* **-c [...]**: The ID of the credential to include in the verifiable presentation

_Output_

```
Presentation response:
{
    id_token=[...],
    vp_token={
        "@context" : [
            "https://www.w3.org/2018/credentials/v1"
        ],
        "holder" : "did:key:z6Mktxjvto1vueoMXiiAtLQiCrDPd2Xoi47isAnjK12nETRX",
        "id" : "urn:uuid:d8a1e5e2-4cb7-4e15-91e8-9c3ed3bad1a5",
        "proof" : {
            "created" : "2022-03-11T13:24:13Z",
            "creator" : "did:key:z6Mktxjvto1vueoMXiiAtLQiCrDPd2Xoi47isAnjK12nETRX",
[...]
        },
        "type" : [
            "VerifiablePresentation"
        ],
        "verifiableCredential" : [
            {
                "@context" : [
                    "https://www.w3.org/2018/credentials/v1"
                ],
[...]
                "credentialSubject" : {
[...]
                    "id" : "did:key:z6Mktxjvto1vueoMXiiAtLQiCrDPd2Xoi47isAnjK12nETRX",
[...]
                },
[...]
                "id" : "urn:uuid:aa1a51cd-3ad2-49fe-ae3e-5ae50c4aed3b",
[...]
}

[...]

Response:
https://verifier.walt.id/success/?access_token=88213206-18ae-4102-9b82-05f10055d6d7
```

The command prints the SIOP response object and the **redirection address**, to which we now have to point our web browser, in order to complete the presentation flow.

The verifier portal shows a successful verification, like shown by this screenshot:

![verifier success page](./verifier-success.png)